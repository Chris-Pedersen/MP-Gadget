# vim: set ft=make:
#
AR ?= ar
LOW_PRECISION ?= double
HIGH_PRECISION ?= double

OPTIONS = $(OPTIMIZE) $(OPT)

CFLAGS = $(OPTIONS) $(GSL_INCL)
CFLAGS += -I../depends/include
CFLAGS += -I../
CFLAGS += "-DLOW_PRECISION=$(LOW_PRECISION)"
CFLAGS += "-DHIGH_PRECISION=$(HIGH_PRECISION)"

BUNDLEDLIBS = -lmpsort-mpi -lradixsort -lbigfile-mpi -lbigfile -lpfft_omp -lfftw3_mpi -lfftw3_omp -lfftw3
LIBS  = -lm $(GSL_LIBS)
LIBS += -L../depends/lib $(BUNDLEDLIBS)
V ?= 0

.objs/%.o: %.c $(INCL)
	@cmd="$(MPICC) -c -o $@ $(CFLAGS) $<"; \
	if test "x$(V)" = "x1" ; then echo $$cmd; fi; \
	mkdir -p `dirname $@`; \
	echo Compiling $<; $$cmd

.objs/test_%: tests/test_%.c %.c %.h ../tests/stub.c ../tests/cmocka.c ../libgadget/libgadget-utils.a
	$(MPICC) $(CFLAGS) -I../tests/ $^ $(LIBS) -o $@

build-tests: $(TESTBIN)

test : build-tests
	trap 'err=1' ERR; for tt in $(SUITE) ; do \
		if [[ "$(MPISUITE)" =~ .*$$tt.* ]]; then \
			mpirun -np 4 .objs/$$tt ;  \
		else \
			.objs/$$tt ; \
		fi ;  \
	done; exit $$err
