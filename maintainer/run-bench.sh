#! /bin/bash

#
# this script runs a benchmark for the code rev directory
# generated by build-MPGadget.sh
# must be run from the dir where the code is. link it there!


code=$1
suite=$2

if [ "x$2" == "x" ]; then
    echo usage $0 code suite
    echo example: $0 coriknl-xxxxxxxx dm-50-512
    echo suite must be declared in benchmarks directory and code must have
    echo been created by build-MPGadget.sh
fi

# make sure there is no tailing /
code=${code///}

trap exit ERR

prefix=$CSCRATCH/mp-gadget-benchmarks/$code
codedir=`readlink -f $code`

builddir=$codedir/build

logdir=$PWD/logs

mkdir -p $logdir

(cd $codedir/benchmarks; bash gen-bench.sh $suite $prefix/$suite)


sbatch -A m3058 --qos premium  -t 30:00\
    -n 128\
    -o $logdir/${code}-${suite}.o%j \
    <<EOF
#! /bin/bash
    cd $prefix/$suite

    export OMP_NUM_THREADS=2 
    srun -n 64 $codedir/build/MP-GenIC paramfile.genic
    srun -n 64 $codedir/build/MP-Gadget paramfile.gadget
    cp cpu.txt $logdir/${code}-${suite}.o${SLURM_ARRAY_JOB_ID}.cpu.txt
EOF
